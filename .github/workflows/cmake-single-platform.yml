name: CMake Qt Cross-Platform Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release
  QT_VERSION: 6.10.0

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: windows-latest
            qt_host: windows
            qt_target: desktop
            generator: "Visual Studio 17 2022"
            build_os: windows
          - os: macos-latest
            qt_host: mac
            qt_target: desktop
            generator: "Xcode"
            build_os: macos

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Cache Qt installation
        uses: actions/cache@v3
        with:
          path: ${{ runner.temp }}/qt
          key: ${{ matrix.os }}-qt-${{ env.QT_VERSION }}-${{ hashFiles('CMakeLists.txt') }}
      - name: Install Qt (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          pip install aqtinstall
          aqt install-qt windows desktop ${{ env.QT_VERSION }} win64_msvc2019_64 -O ${{ runner.temp }}/qt
          aqt install-tool windows desktop tools_openssl_x64 -O ${{ runner.temp }}/qt

      - name: Install Qt (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install qt@6
          echo "CMAKE_PREFIX_PATH=$(brew --prefix qt@6)/lib/cmake" >> $GITHUB_ENV
      - name: Configure CMake
        run: |
          # 设置Qt路径（如果使用aqtinstall）
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            export Qt6_DIR="${{ runner.temp }}/qt/${{ env.QT_VERSION }}/msvc2019_64/lib/cmake/Qt6"
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            export Qt6_DIR="${{ runner.temp }}/qt/${{ env.QT_VERSION }}/clang_64/lib/cmake/Qt6"
          fi
          
          cmake -B ${{github.workspace}}/build \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -G "${{ matrix.generator }}" \
            -DCMAKE_PREFIX_PATH=${{ env.CMAKE_PREFIX_PATH }}

      - name: Build
        run: |
          cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel 4

      - name: Test
        working-directory: ${{github.workspace}}/build
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ctest -C ${{env.BUILD_TYPE}} --output-on-failure
          else
            ctest -C ${{env.BUILD_TYPE}} --output-on-failure
          fi

      - name: Upload Artifacts (Windows)
        if: matrix.os == 'windows-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: |
            ${{github.workspace}}/build/**/*.exe
            ${{github.workspace}}/build/**/*.dll

      - name: Upload Artifacts (macOS)
        if: matrix.os == 'macos-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: macOS-Build
          path: |
            ${{github.workspace}}/build/**/*.app
            ${{github.workspace}}/build/**/*.dylib

      - name: Upload Artifacts (Linux)
        if: matrix.os == 'ubuntu-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: Linux-Build
          path: ${{github.workspace}}/build/**